# 現在のタスク

## 引き継ぎ情報

### プロジェクト概要
- **BrainBusters**: Slay the Spire風のローグライクカードゲーム（React Native/Expo）
- 500の哲学概念カードを使ったターン制バトル
- 50階ダンジョン、10体のボス（5階ごと: 5, 10, 15, 20, 25, 30, 35, 40, 45, 50階）

### 現在の状態（実装済み機能）
| カテゴリ | 内容 |
|---------|------|
| バトルシステム | 敵の攻撃は一体ずつ順次処理、メッセージはフェード表示 |
| カード効果 | 13カテゴリ別のテンプレート実装済み |
| コンボシステム | 14種のコンボ実装済み |
| リスク/リターン | 21枚（HPコスト4枚、条件付き4枚、ギャンブル13枚） |
| バトルUI | フローティングエフェクト、敵表示160x120px、HPバー20px+テキスト内蔵 |
| バトル演出 | 50+ダメージ火花、100+爆発+シェイク、敵撃破パーティクル、ボス演出 |
| 難易度 | 敵ダメージ2倍・HP1.5倍・調和強化 |
| デバッグモード | 14プリセット付き、全シナリオテスト可能 |
| 報酬画面 | メッセージサイズ16pt以上に改善済み、ボス撃破パーティクル |

### 重要ファイル
| ファイル | 説明 |
|---------|------|
| `src/screens/BattleScreen.tsx` | バトル画面（エフェクト統合済み） |
| `src/screens/DebugScreen.tsx` | デバッグ画面（14プリセット、カスタム設定） |
| `src/screens/RewardScreen.tsx` | 報酬画面（ストック入替、ボス報酬レリック） |
| `src/components/effects/` | バトルエフェクト（DamageEffect, DefeatEffect） |
| `src/data/cards.ts` | カード生成・効果テンプレート |
| `src/data/enemies.ts` | 敵生成（generateEnemyGroup: overrideCount対応） |
| `src/types/game.ts` | ゲーム設定（GAME_CONFIG） |
| `src/store/runStore.ts` | ゲーム状態管理（initBattleState: overrideNodeType対応） |

### デバッグモード
タイトル画面の「デバッグ」ボタン（`__DEV__`時のみ表示）から起動。

**機能:**
- **プリセット選択**: 14種のテストシナリオをワンタップで設定反映
- **カスタム設定**: テストモード/ノードタイプ/階層/敵数/HP/ストック数を自由に設定
- **バトル中断**: 「← 中断」ボタンでメニューに戻れる
- **報酬画面テスト**: バトルせずに直接報酬画面を開ける

**プリセット一覧:**
1-7: バトルテスト（通常/エリート/ボス、各種条件）
8-14: 報酬画面テスト（ストック空/一部/満杯、ボス報酬レリック）

### 直近セッションの作業内容
1. **Phase 6: バトル演出実装**
   - ダメージエフェクト（50+で火花、100+で爆発+画面シェイク）
   - 敵撃破エフェクト（通常/エリート/ボス別パーティクル）
   - ボス撃破時の特別演出（画面フラッシュ+テキスト表示）
   - BattleScreenへの統合完了

### 次のタスク
**Phase 7: コンテンツ拡充** に進む

---

## 手動テスト（デバッグモード使用）

### バトルテスト
| # | シナリオ | 設定 | 確認ポイント |
|---|---------|------|-------------|
| 1 | 通常バトル基本 | 1階/敵1体/HP満タン/ストック0 | 基本動作確認 |
| 2 | 通常バトル敵3体 | 25階/敵3体/HP満タン/ストック0 | 敵3体の表示・ターゲット切替 |
| 3 | 高難度+ストック満杯 | 45階/敵3体/HP瀕死(10)/ストック5 | ストックカード使用・低HP警告 |
| 4 | エリート2体 | 20階/敵2体/HP半分(35)/ストック3 | エリート強さ・ストック使用 |
| 5 | 序盤ボス | 5階ボス(懐疑の淵)/HP満タン/ストック0 | ボス表示・行動パターン |
| 6 | 中盤ボス | 25階ボス(功利の天秤)/HP半分/ストック3 | ボス強さ・ストック戦略 |
| 7 | 最終ボス極限 | 50階ボス/HP瀕死(10)/ストック5 | 最高難度・全機能確認 |

### 報酬画面テスト
| # | シナリオ | 設定 | 確認ポイント |
|---|---------|------|-------------|
| 8 | ストック空→追加 | 通常報酬/ストック0 | カードをストックに追加できる |
| 9 | ストック一部→追加 | 通常報酬/ストック3 | 追加後のストック表示 |
| 10 | ストック満杯→入替 | 通常報酬/ストック5 | 入れ替えUI・警告メッセージ表示 |
| 11 | エリート報酬+満杯 | エリート報酬/ストック5 | 高レアカード・入れ替え動作 |
| 12 | ボス報酬+レリック | 5階ボス報酬/ストック0 | レリック表示・獲得 |
| 13 | ボス報酬複合 | 25階ボス報酬/ストック5 | レリック+カード入替 |
| 14 | 最終ボス報酬 | 50階ボス報酬 | 最終レリック確認 |

### UI表示テスト
| # | 確認内容 |
|---|---------|
| 15 | 敵3体の表示レイアウト（重なりなし・40pxオフセット） |
| 16 | ストック満杯警告メッセージの文字サイズ（16pt以上） |
| 17 | ボス名・HPバー・HP数値の視認性 |

### 操作フローテスト
| # | 確認内容 |
|---|---------|
| 18 | バトル「← 中断」→メニュー復帰 |
| 19 | バトル勝利→「報酬画面へ」→操作→メニュー復帰 |
| 20 | 報酬画面「← 中断」→メニュー復帰 |

---

## Phase 6: バトル演出 ✅完了
- [x] ダメージ演出の強化（50↑火花、100↑爆発+シェイク）
- [x] 敵撃破時のエフェクト（通常/エリート/ボス別）
- [x] ボス戦勝利時の演出（画面フラッシュ+テキスト+パーティクル）
- [x] 報酬画面の演出（紙吹雪+フラッシュ+タイトルアニメ、ボス時追加演出）

**追加ファイル:**
- `src/components/effects/DamageEffect.tsx` - 火花・爆発エフェクト
- `src/components/effects/DefeatEffect.tsx` - 敵撃破エフェクト
- `docs/PHASE6_BATTLE_EFFECTS.md` - 設計ドキュメント

**報酬画面演出（RewardScreen.tsx）:**
- 全報酬画面: 画面フラッシュ、タイトルアニメ、30個紙吹雪
- ボス報酬: 金色フラッシュ、パルスタイトル、40個爆発パーティクル

---

## 🐛 バグ・問題点

### 1. ダメージテキスト重複バグ
- **症状**: 「45ダメージ、45ダメージ」のようにテキストが被って表示される
- **発生箇所**: BattleScreen.tsx のフローティングダメージ表示
- **調査必要**: 同時に複数のダメージが発生した場合の処理を確認

### 2. ギャンブルカードの説明不足
- **問題**: ギャンブルカード（ランダム効果）の説明がカードに表示されていない
- **影響**: プレイヤーには「変な動作をした」ようにしか見えない
- **対応**: カード説明文にギャンブル要素を明記する必要あり
  - 例: 「🎲 ダメージ: 10〜30（ランダム）」
  - 例: 「⚠️ HPコスト: 自分に5ダメージ」

### 3. 敵HPが回復するバグ（要調査）
- **症状**: 戦闘中に敵のHPが回復することがある
- **問題1**: バグなのか、意図した仕様なのか不明
- **問題2**: 仕様だとしても、なぜ回復したのかのメッセージが表示されない
- **調査項目**:
  - 敵に回復行動が実装されているか確認（enemies.tsのactionPatterns）
  - 回復時のメッセージ表示処理があるか確認
  - もしバグの場合、どこでHP値が変更されているか特定

### 4. 報酬画面の進行バグ（要ダブルチェック）
- **症状1**: 報酬画面から先に進めなくなる
- **症状2**: ストックカードを2回選択すると報酬が最初からトリガーされる
- **対応**: Phase 6.5完了後に報酬画面の全フローをダブルチェック
- **確認項目**:
  - 報酬選択→次の画面への遷移
  - ストック選択→入替→完了フロー
  - ボス報酬→レリック選択→完了フロー
  - 各ボタンの連打耐性

---

## Phase 6.5: エフェクト強化 ← 次

### 現状の問題
- パーティクルが全体的に控えめすぎる
- 小さなアクションにエフェクトがない
- ダメージ50未満にはエフェクトがない

### 既存エフェクトの強化
- [ ] パーティクル数を増やす（現在の1.5〜2倍）
- [ ] パーティクルサイズを大きくする
- [ ] アニメーション時間を調整（もう少し長く）
- [ ] 色をより鮮やかに

### 追加エフェクト候補一覧

#### カード使用時
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| 攻撃カード使用 | 剣閃/スラッシュエフェクト | 高 |
| 防御カード使用 | シールド展開エフェクト | 高 |
| スキルカード使用 | 魔法陣/オーラエフェクト | 中 |
| ストックカード使用 | 特別な光エフェクト | 中 |
| コスト0カード | クイック/スピードエフェクト | 低 |
| 高コスト(3+)カード | パワーチャージエフェクト | 低 |

#### ダメージ関連
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| 1〜19ダメージ | 小さな衝撃波 | 高 |
| 20〜49ダメージ | 中程度の衝撃+数字強調 | 高 |
| 50〜99ダメージ | 火花（現在実装済み、強化） | 高 |
| 100+ダメージ | 爆発+シェイク（現在実装済み、強化） | 高 |
| クリティカル/弱点 | 特別なフラッシュ | 中 |

#### 防御/回復関連
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| ブロック獲得 | シールド出現アニメ | 高 |
| ブロックでダメージ軽減 | シールドヒットエフェクト | 高 |
| ブロック貫通ダメージ | シールド破壊エフェクト | 中 |
| HP回復 | 緑の回復パーティクル | 高 |
| HP全回復 | 大きな回復エフェクト | 中 |

#### 状態異常/バフ
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| バフ獲得（筋力等） | 上昇オーラ | 中 |
| デバフ獲得（脆弱等） | 下降オーラ/紫煙 | 中 |
| 毒ダメージ | 緑の泡エフェクト | 低 |
| 炎上ダメージ | 炎エフェクト | 低 |
| 状態異常解除 | クリアエフェクト | 低 |

#### ターン/エネルギー
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| ターン開始 | 波紋/オーラ展開 | 中 |
| エネルギー回復 | 光の粒子 | 低 |
| エネルギー消費 | 消費エフェクト | 低 |
| カードドロー | カード出現アニメ | 中 |

#### コンボ/特殊
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| コンボ発動 | コンボフラッシュ+テキスト | 高 |
| ギャンブル成功 | ラッキーエフェクト | 中 |
| ギャンブル失敗 | 残念エフェクト | 中 |
| HPコストカード | 自傷ダメージエフェクト | 中 |
| 条件付きカード成功 | ボーナスエフェクト | 低 |

#### UI/フィードバック
| 対象 | エフェクト案 | 優先度 |
|------|-------------|--------|
| 敵選択時 | ターゲットマーカー点滅 | 中 |
| 低HP警告 | 画面端の赤いパルス | 高 |
| 敵攻撃予告（強攻撃） | 危険マーク点滅 | 中 |
| ボタン押下 | タップフィードバック | 低 |

---

## Phase 7: コンテンツ拡充
- [ ] ショップ機能充実
- [ ] 図鑑機能
- [ ] レリック効果の確認・修正
- [ ] 設定画面の改善
- [ ] **最終ボス報酬の見直し**: 50階ボスのレリックは使う機会がないため別報酬に変更
  - 案1: ゴールド大量獲得
  - 案2: エンディング演出・実績解除
  - 案3: 特別なカードスキン解放

---

## Phase 8: 敵の哲学的テーマ化
- [ ] 敵キャラを哲学的テーマ化（「意識とは何か」「クオリア」など）
- [ ] カードの概念と関連付けてシナジーを作る

---

## Phase 9: 画像生成
- [ ] カード画像の生成（500枚）
- [ ] 敵キャラ画像の生成
- [ ] ボス画像の生成

---

## Phase 10: カードUI改善
- [ ] カード表示の大型化（画像表示対応）
- [ ] カルーセル型カード選択UI（3D回転式）

---

## 未来機能（Future Features）

### ステージ拡張
- [ ] 50階以上のステージ追加
- [ ] 新ボス追加（既存10体+α）
- [ ] 高難度エリア（敵の強化・新ギミック）

### 無限モード
- [ ] エンドレスモードの実装
  - ボス周回（5階ごとにボス、無限ループ）
  - 階層に応じた難易度スケーリング
  - ハイスコア記録
- [ ] デイリーチャレンジ（シード固定の日替わりラン）
