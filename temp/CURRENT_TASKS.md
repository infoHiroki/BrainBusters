# 現在のタスク

## 引き継ぎ情報

### プロジェクト概要
- **BrainBusters**: Slay the Spire風のローグライクカードゲーム（React Native/Expo）
- 500の哲学概念カードを使ったターン制バトル
- 50階ダンジョン、10体のボス（5階ごと: 5, 10, 15, 20, 25, 30, 35, 40, 45, 50階）

### 現在の状態（実装済み機能）
| カテゴリ | 内容 |
|---------|------|
| バトルシステム | 敵の攻撃は一体ずつ順次処理、メッセージはフェード表示 |
| カード効果 | 13カテゴリ別のテンプレート実装済み |
| コンボシステム | 14種のコンボ実装済み |
| リスク/リターン | 21枚（HPコスト4枚、条件付き4枚、ギャンブル13枚） |
| バトルUI | フローティングエフェクト、敵表示160x120px、HPバー20px+テキスト内蔵 |
| バトル演出 | 50+ダメージ火花、100+爆発+シェイク、敵撃破パーティクル、ボス演出 |
| 報酬画面演出 | サイケデリックエフェクト（SVG）、紙吹雪、ボス用爆発 |
| 難易度 | 敵ダメージ2倍・HP1.5倍・調和強化 |
| デバッグモード | 14プリセット付き、全シナリオテスト可能 |

### 重要ファイル
| ファイル | 説明 |
|---------|------|
| `src/screens/BattleScreen.tsx` | バトル画面（エフェクト統合済み） |
| `src/screens/DebugScreen.tsx` | デバッグ画面（14プリセット、カスタム設定） |
| `src/screens/RewardScreen.tsx` | 報酬画面（サイケデリックエフェクト、ストック入替） |
| `src/components/effects/` | エフェクト（DamageEffect, DefeatEffect, PsychedelicEffect） |
| `src/data/cards.ts` | カード生成・効果テンプレート |
| `src/data/enemies.ts` | 敵生成（generateEnemyGroup: overrideCount対応） |
| `src/types/game.ts` | ゲーム設定（GAME_CONFIG） |
| `src/store/runStore.ts` | ゲーム状態管理（initBattleState: overrideNodeType対応） |

### デバッグモード
タイトル画面の「デバッグ」ボタン（`__DEV__`時のみ表示）から起動。

**機能:**
- **プリセット選択**: 14種のテストシナリオをワンタップで設定反映
- **カスタム設定**: テストモード/ノードタイプ/階層/敵数/HP/ストック数を自由に設定
- **バトル中断**: 「← 中断」ボタンでメニューに戻れる
- **報酬画面テスト**: バトルせずに直接報酬画面を開ける

**プリセット一覧:**
1-7: バトルテスト（通常/エリート/ボス、各種条件）
8-14: 報酬画面テスト（ストック空/一部/満杯、ボス報酬レリック）

### 直近セッションの作業内容
1. **Phase 6: バトル演出実装** ✅
   - ダメージエフェクト（50+で火花、100+で爆発+画面シェイク）
   - 敵撃破エフェクト（通常/エリート/ボス別パーティクル）
   - ボス撃破時の特別演出（画面フラッシュ+テキスト表示）

2. **Phase 6.5: 報酬画面サイケデリックエフェクト** ✅
   - ヒルマ・アフ・クリント風の宇宙的・スピリチュアル演出
   - コズミックリング（無限に広がり続ける）
   - 蓮の花びら（複数レイヤー、回転）
   - 中心の脈動（3層、回転、ずらし表示）
   - 紙吹雪（継続的に降り注ぐ）
   - ボス戦用爆発エフェクト

### 次のタスク
**Phase 7: コンテンツ拡充** に進む

---

## 手動テスト（デバッグモード使用）

### バトルテスト
| # | シナリオ | 設定 | 確認ポイント |
|---|---------|------|-------------|
| 1 | 通常バトル基本 | 1階/敵1体/HP満タン/ストック0 | 基本動作確認 |
| 2 | 通常バトル敵3体 | 25階/敵3体/HP満タン/ストック0 | 敵3体の表示・ターゲット切替 |
| 3 | 高難度+ストック満杯 | 45階/敵3体/HP瀕死(10)/ストック5 | ストックカード使用・低HP警告 |
| 4 | エリート2体 | 20階/敵2体/HP半分(35)/ストック3 | エリート強さ・ストック使用 |
| 5 | 序盤ボス | 5階ボス(懐疑の淵)/HP満タン/ストック0 | ボス表示・行動パターン |
| 6 | 中盤ボス | 25階ボス(功利の天秤)/HP半分/ストック3 | ボス強さ・ストック戦略 |
| 7 | 最終ボス極限 | 50階ボス/HP瀕死(10)/ストック5 | 最高難度・全機能確認 |

### 報酬画面テスト
| # | シナリオ | 設定 | 確認ポイント |
|---|---------|------|-------------|
| 8 | ストック空→追加 | 通常報酬/ストック0 | カードをストックに追加できる |
| 9 | ストック一部→追加 | 通常報酬/ストック3 | 追加後のストック表示 |
| 10 | ストック満杯→入替 | 通常報酬/ストック5 | 入れ替えUI・警告メッセージ表示 |
| 11 | エリート報酬+満杯 | エリート報酬/ストック5 | 高レアカード・入れ替え動作 |
| 12 | ボス報酬+レリック | 5階ボス報酬/ストック0 | レリック表示・獲得 |
| 13 | ボス報酬複合 | 25階ボス報酬/ストック5 | レリック+カード入替 |
| 14 | 最終ボス報酬 | 50階ボス報酬 | 最終レリック確認 |

### UI表示テスト
| # | 確認内容 |
|---|---------|
| 15 | 敵3体の表示レイアウト（重なりなし・40pxオフセット） |
| 16 | ストック満杯警告メッセージの文字サイズ（16pt以上） |
| 17 | ボス名・HPバー・HP数値の視認性 |

### 操作フローテスト
| # | 確認内容 |
|---|---------|
| 18 | バトル「← 中断」→メニュー復帰 |
| 19 | バトル勝利→「報酬画面へ」→操作→メニュー復帰 |
| 20 | 報酬画面「← 中断」→メニュー復帰 |

---

## Phase 6: バトル演出 ✅完了
- [x] ダメージ演出の強化（50↑火花、100↑爆発+シェイク）
- [x] 敵撃破時のエフェクト（通常/エリート/ボス別）
- [x] ボス戦勝利時の演出（画面フラッシュ+テキスト+パーティクル）

**追加ファイル:**
- `src/components/effects/DamageEffect.tsx` - 火花・爆発エフェクト
- `src/components/effects/DefeatEffect.tsx` - 敵撃破エフェクト
- `docs/PHASE6_BATTLE_EFFECTS.md` - 設計ドキュメント

---

## 🐛 バグ・問題点

### 1. ダメージテキスト重複バグ
- **症状**: 「45ダメージ、45ダメージ」のようにテキストが被って表示される
- **発生箇所**: BattleScreen.tsx のフローティングダメージ表示
- **調査必要**: 同時に複数のダメージが発生した場合の処理を確認

### 2. カード説明文の不足（広範囲）
- **問題**: 多くのカードに効果の説明が表示されていない
- **影響**: プレイヤーが何が起きたかわからない
- **対象カード**:
  - ギャンブルカード: 「🎲 ダメージ: 10〜30（ランダム）」
  - HPコストカード: 「⚠️ HPコスト: 自分に5ダメージ」
  - 条件付きカード: 発動条件の説明
  - バフ/デバフカード: 効果の詳細
  - コンボカード: コンボ条件の説明
- **対応**: cards.tsのdescription生成ロジックを改善

### 3. 敵HPが回復するバグ（要調査）
- **症状**: 戦闘中に敵のHPが回復することがある
- **問題1**: バグなのか、意図した仕様なのか不明
- **問題2**: 仕様だとしても、なぜ回復したのかのメッセージが表示されない
- **調査項目**:
  - 敵に回復行動が実装されているか確認（enemies.tsのactionPatterns）
  - 回復時のメッセージ表示処理があるか確認
  - もしバグの場合、どこでHP値が変更されているか特定

### 4. 報酬画面の進行バグ（要ダブルチェック）
- **症状1**: 報酬画面から先に進めなくなる
- **症状2**: ストックカードを2回選択すると報酬が最初からトリガーされる
- **対応**: 報酬画面の全フローをダブルチェック
- **確認項目**:
  - 報酬選択→次の画面への遷移
  - ストック選択→入替→完了フロー
  - ボス報酬→レリック選択→完了フロー
  - 各ボタンの連打耐性

### 5. 敵撃破エフェクトの表示時間（要確認）
- **問題**: 敵撃破時のエフェクトが最後まで表示されているか不明
- **懸念**: 報酬画面への遷移が早すぎてエフェクトが見えない可能性
- **確認方法**: 実際のバトルでテスト（デバッグモードでは確認不可）
- **対応**: 必要に応じてBattleScreen.tsxのdelayを調整

### 6. 敗北時の情報不足
- **症状**: プレイヤーが敗北した時、突然死ぬので何が起きたかわからない
- **問題点**:
  - どの敵からダメージを受けたか不明
  - 何ダメージ受けたか不明
  - 死亡直前の状況が見えない
- **改善案**:
  - 敗北確定時にダメージログを表示
  - 死亡演出を追加（画面暗転、ダメージ表示）
  - 敗北画面に「何が起きたか」のサマリーを表示
  - 最後のダメージをスローモーションで表示

---

## Phase 6.5: 報酬画面サイケデリックエフェクト ✅完了

### 実装内容（PsychedelicEffect.tsx）
| 要素 | 説明 |
|------|------|
| コズミックリング | 中心から無限に広がり続ける同心円（22-30個） |
| 蓮の花びら | 5-6層、各レイヤー異なる回転速度、呼吸アニメ |
| オーラの波動 | 2層の逆回転波形パターン |
| 中心の脈動 | 3層、1.5秒ずつずらし、各層異なる色・回転速度・逆回転 |
| 紙吹雪 | 110-160個、継続的に降り注ぐ、ひらひら効果 |
| ボス用爆発 | 8つのリングが中心から同時に爆発的に拡大 |

### 技術詳細
- react-native-svg使用（Circle, Path, RadialGradient等）
- ヒルマ・アフ・クリント風の宇宙的・スピリチュアルデザイン
- 全画面フルカバー（消滅点からの無限拡大）
- ループアニメーション（始点=終点でカクつき防止）
- ボス戦と通常戦で演出差別化

---

## Phase 6.6: バトルエフェクトのSVG化
- [ ] **ダメージエフェクト（DamageEffect.tsx）のSVG化**
  - 絵文字（💥✨⚡🔥）をSVGアニメーションに変更
  - 報酬画面と同様のサイケデリック/宇宙的デザイン
  - 火花・爆発をSVGで表現（拡大するリング、放射状の光線等）

- [ ] **撃破エフェクト（DefeatEffect.tsx）のSVG化**
  - 絵文字（💨✨💫⭐🌟🔥）をSVGアニメーションに変更
  - 通常撃破: 煙・消滅パーティクル
  - エリート撃破: 金色の光、星の爆発
  - ボス撃破: 大規模な宇宙的爆発、コズミックリング

- [ ] **ヒルマ・アフ・クリント風デザイン統一**
  - 同心円、蓮の花、幾何学模様
  - グラデーション（RadialGradient）活用
  - 全エフェクトで統一感のあるビジュアル

---

## Phase 7: コンテンツ拡充
- [ ] ショップ機能充実
- [ ] 図鑑機能
- [ ] レリック効果の確認・修正
- [ ] 設定画面の改善
- [ ] **最終ボス報酬の見直し**: 50階ボスのレリックは使う機会がないため別報酬に変更
  - 案1: ゴールド大量獲得
  - 案2: エンディング演出・実績解除
  - 案3: 特別なカードスキン解放

---

## Phase 8: 敵の哲学的テーマ化
- [ ] 敵キャラを哲学的テーマ化（「意識とは何か」「クオリア」など）
- [ ] カードの概念と関連付けてシナジーを作る

---

## Phase 9: 画像生成
- [ ] カード画像の生成（500枚）
- [ ] 敵キャラ画像の生成
- [ ] ボス画像の生成

---

## Phase 10: カードUI改善
- [ ] カード表示の大型化（画像表示対応）
- [ ] カルーセル型カード選択UI（3D回転式）

---

## 未来機能（Future Features）

### ステージ拡張
- [ ] 50階以上のステージ追加
- [ ] 新ボス追加（既存10体+α）
- [ ] 高難度エリア（敵の強化・新ギミック）

### 無限モード
- [ ] エンドレスモードの実装
  - ボス周回（5階ごとにボス、無限ループ）
  - 階層に応じた難易度スケーリング
  - ハイスコア記録
- [ ] デイリーチャレンジ（シード固定の日替わりラン）
